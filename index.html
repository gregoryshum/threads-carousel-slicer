<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover"/>
<title>Pinchable Carousel Slicer — 3:4 Portrait • Seam‑Safe (No Bleed)</title>
<script src="https://cdn.jsdelivr.net/npm/jszip@3.10.1/dist/jszip.min.js"></script>
<style>
:root{
  --bg:#0b0f14; --card:#0f172a; --ink:#e5e7eb; --muted:#94a3b8; --line:#1e293b; --accent:#22c55e;
  --shadow:0 8px 24px rgba(0,0,0,.25);
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
.header{position:sticky;top:0;z-index:9;backdrop-filter:blur(10px);background:rgba(11,15,20,.75);border-bottom:1px solid var(--line)}
.header-inner{display:flex;align-items:center;justify-content:space-between;padding:12px 16px}
.container{max-width:760px;margin:0 auto;padding:12px 12px 84px}
.card{background:var(--card);border:1px solid var(--line);border-radius:14px;box-shadow:var(--shadow);padding:12px}
.hint{color:var(--muted);font-size:12px;margin-top:6px}
.row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
.input{border:1px solid var(--line);background:#0b1220;color:#e5e7eb;padding:10px 12px;border-radius:12px}
.btn{border:none;background:#1f2937;color:#e5e7eb;padding:12px 14px;border-radius:12px}
.btn.primary{background:#22c55e;color:#04240f;font-weight:700}
.btn.small{padding:8px 10px;border-radius:10px;font-size:13px}
.actions{position:fixed;left:0;right:0;bottom:0;z-index:10;background:rgba(11,15,20,.9);border-top:1px solid var(--line);backdrop-filter:blur(10px)}
.actions-inner{max-width:760px;margin:0 auto;padding:10px;display:flex;gap:10px}.actions .btn{flex:1}
.cap{max-height:240px;width:100%;object-fit:contain;border-radius:12px}
#seamWrap{overflow-x:auto;overflow-y:hidden;border:1px solid var(--line);border-radius:12px;background:#0b1220;padding:6px}
#seamRow{display:flex;gap:0} #seamRow img{height:180px;width:auto;display:block}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
.thumb{border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#0b1220}
.thumb img{display:block;width:100%;height:auto}
.thumb .meta{display:flex;align-items:center;justify-content:space-between;gap:6px;padding:8px;font-size:12px;color:var(--muted)}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.85);display:none;align-items:center;justify-content:center;z-index:20}
.modal.open{display:flex}.modal-inner{max-width:100vw;max-height:100vh;padding:12px;position:relative}
.modal img{max-width:100%;max-height:85vh;border-radius:12px;display:block;margin:0 auto}
.modal .close{position:absolute;top:16px;right:16px}
.lb{position:fixed;inset:0;background:rgba(0,0,0,.92);display:none;z-index:30;flex-direction:column}
.lb.open{display:flex}.lb-header{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid var(--line)}
.lb-body{flex:1;overflow:auto;padding:10px}.lb-canvas{width:fit-content;transform-origin:0 0}.lb-row{display:flex;gap:0}
@media (min-width:768px){.cap{max-height:300px}}
</style>
</head>
<body>
  <div class="header"><div class="header-inner">
    <div><strong>Pinchable Carousel Slicer</strong><div class="hint">3:4 portrait • Seam‑Safe (no bleed)</div></div>
    <button id="newBtn" class="btn small">New image</button>
  </div></div>

  <div class="container">
    <div class="card">
      <div class="row">
        <input id="fileLib" class="input" type="file" accept="image/*">
        <input id="fileCam" class="input" type="file" accept="image/*" capture="environment" style="display:none">
        <button id="libBtn" class="btn">Choose from Library</button>
        <button id="camBtn" class="btn">Use Camera</button>
      </div>
      <div class="row" style="margin-top:10px">
        <label class="hint">Slices <input id="slices" class="input" style="width:84px" type="number" min="2" max="12" value="3"></label>
        <label class="hint">Export width (px) <input id="exportW" class="input" style="width:110px" type="number" min="600" max="4096" value="1080"></label>
        <label class="hint">Format
          <select id="format" class="input" style="width:120px">
            <option value="image/png" selected>PNG (recommended)</option>
            <option value="image/jpeg">JPEG</option>
          </select>
        </label>
        <label class="hint"><input id="snapInt" type="checkbox" checked> integer‑snap crop</label>
      </div>
      <div id="meta" class="hint"></div>
    </div>

    <div class="card" id="previewCard" style="margin-top:12px;display:none">
      <img id="preview" alt="source" class="cap">
    </div>

    <div class="card" id="outputCard" style="margin-top:12px;display:none">
      <div class="row" style="justify-content:space-between">
        <strong>Slices</strong><button id="zipBtn" class="btn small">Download .zip</button>
      </div>
      <div id="thumbs" class="grid" style="margin-top:10px"></div>

      <div style="margin-top:12px">
        <div class="row" style="justify-content:space-between">
          <strong>Live Seam Checker</strong>
          <div class="row">
            <label class="hint"><input id="seamBorders" type="checkbox"> borders</label>
            <button id="seamOpen" class="btn small">Open lightbox</button>
          </div>
        </div>
        <div id="seamWrap" style="margin-top:8px"><div id="seamRow"></div></div>
      </div>
    </div>
  </div>

  <div class="actions"><div class="actions-inner">
    <button id="sliceBtn" class="btn primary" disabled>Slice</button>
    <button id="dlAllBtn" class="btn" disabled>Download all</button>
  </div></div>

  <div id="modal" class="modal" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal-inner">
      <img id="modalImg" alt="expanded"><button class="btn small close" id="modalClose">Close ×</button>
    </div>
  </div>

  <div id="lb" class="lb" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="lb-header"><div>Seam Lightbox</div>
      <div class="row"><label class="hint">Zoom <input id="lbZoom" type="range" min="30" max="200" value="60"></label>
        <button id="lbClose" class="btn small">Close ×</button></div>
    </div>
    <div class="lb-body"><div id="lbCanvas" class="lb-canvas"><div id="lbRow" class="lb-row"></div></div></div>
  </div>

<script>
const dpr = window.devicePixelRatio || 1;
const $ = (id)=>document.getElementById(id);
const els = {
  fileLib: $('fileLib'), fileCam: $('fileCam'),
  libBtn: $('libBtn'), camBtn: $('camBtn'),
  format: $('format'), slices: $('slices'), exportW: $('exportW'),
  snapInt: $('snapInt'),
  sliceBtn: $('sliceBtn'), dlAllBtn: $('dlAllBtn'),
  previewCard: $('previewCard'), preview: $('preview'), meta: $('meta'),
  outputCard: $('outputCard'), thumbs: $('thumbs'),
  seamWrap: $('seamWrap'), seamRow: $('seamRow'), seamBorders: $('seamBorders'), seamOpen: $('seamOpen'),
  modal: $('modal'), modalImg: $('modalImg'), modalClose: $('modalClose'),
  lb: $('lb'), lbRow: $('lbRow'), lbCanvas: $('lbCanvas'), lbZoom: $('lbZoom'), lbClose: $('lbClose'),
  zipBtn: $('zipBtn'),
};
let imgMeta = null, imgUrl = null, outputs = [];
function createCanvas(w,h){
  const c = document.createElement('canvas'); c.width = Math.round(w*dpr); c.height = Math.round(h*dpr);
  const ctx = c.getContext('2d'); ctx.setTransform(dpr,0,0,dpr,0,0); ctx.imageSmoothingQuality='high';
  return {c, ctx};
}
function resetAll(){ if(imgUrl) URL.revokeObjectURL(imgUrl); imgUrl=null; imgMeta=null;
  els.previewCard.style.display='none'; els.outputCard.style.display='none';
  els.sliceBtn.disabled=true; els.dlAllBtn.disabled=true; els.thumbs.innerHTML=''; els.seamRow.innerHTML=''; els.lbRow.innerHTML='';
  els.meta.textContent='';
}
function handleFile(file){
  if(!file || !/^image\//.test(file.type)) return alert('Pick an image');
  if(/heic|heif/i.test(file.type)) return alert('HEIC not supported by many browsers. Use JPG/PNG.');
  if(imgUrl) URL.revokeObjectURL(imgUrl); imgUrl = URL.createObjectURL(file);
  const img = new Image(); img.onload=()=>{
    imgMeta = {w:img.naturalWidth, h:img.naturalHeight};
    els.preview.src=imgUrl; els.previewCard.style.display='block';
    els.meta.textContent = `${imgMeta.w}×${imgMeta.h}px`;
    els.sliceBtn.disabled=false; els.outputCard.style.display='none'; els.thumbs.innerHTML=''; els.seamRow.innerHTML=''; els.lbRow.innerHTML='';
  }; img.onerror=()=>alert('Failed to load image'); img.src=imgUrl;
}
els.libBtn.onclick=()=>els.fileLib.click(); els.camBtn.onclick=()=>els.fileCam.click();
els.fileLib.onchange=e=>handleFile(e.target.files&&e.target.files[0]); els.fileCam.onchange=e=>handleFile(e.target.files&&e.target.files[0]);

function computePlan(){
  if(!imgMeta) return null;
  const W=imgMeta.w, H=imgMeta.h, N=Math.max(2,Math.min(12,parseInt(els.slices.value||'3'))), ASPECT=3/4;
  const sliceMaxW = Math.floor(W / N);
  let cropH = Math.min(H, Math.floor(sliceMaxW / ASPECT)); // integer
  let sliceW = Math.floor(cropH * ASPECT);                 // integer
  const totalW = sliceW * N;
  const offsetX = Math.floor((W - totalW)/2), offsetY = Math.floor((H - cropH)/2);
  return {N, sliceW, cropH, totalW, offsetX, offsetY, ASPECT, W, H};
}
function exactSlices(plan){
  const N=plan.N; const arr=[];
  let remainder = plan.W - (plan.sliceW * N) - (plan.offsetX*2);
  let accX = plan.offsetX;
  for(let i=0;i<N;i++){
    let sw = plan.sliceW;
    if(remainder>0){ sw+=1; remainder-=1; }  // add the leftover pixel to first slices
    const sx = accX;
    arr.push({sx, sy:plan.offsetY, sw:sw, sh:plan.cropH});
    accX += sw;
  }
  return arr;
}

els.sliceBtn.onclick = async ()=>{
  if(!imgMeta) return;
  const plan = computePlan(); if(!plan){ alert('Use a wider image'); return; }
  const img = new Image(); img.src = imgUrl; await img.decode();
  outputs=[]; els.thumbs.innerHTML=''; els.seamRow.innerHTML=''; els.lbRow.innerHTML='';
  const exportCap=Math.max(600,Math.min(4096,parseInt(els.exportW.value||'1080')));
  const defs = exactSlices(plan);
  for(let i=0;i<defs.length;i++){
    const S=defs[i];
    const targetW = Math.min(exportCap, Math.round(plan.sliceW));
    const targetH = Math.round(targetW / plan.ASPECT);
    const {c, ctx} = createCanvas(targetW, targetH);
    ctx.drawImage(img, S.sx, S.sy, S.sw, S.sh, 0, 0, targetW, targetH);
    const mime = els.format.value;
    const dataUrl = c.toDataURL(mime, mime==='image/jpeg'?0.95:undefined);
    const name = `threads_3x4_${String(i+1).padStart(3,'0')}.${mime==='image/png'?'png':'jpg'}`;
    outputs.push({url:dataUrl, name});
    const card=document.createElement('div'); card.className='thumb';
    const im=document.createElement('img'); im.src=dataUrl; im.alt=name; im.loading='lazy'; im.onclick=()=>openModal(dataUrl);
    const meta=document.createElement('div'); meta.className='meta';
    const span=document.createElement('span'); span.textContent=name; const btn=document.createElement('button'); btn.className='btn small'; btn.textContent='Save'; btn.onclick=()=>downloadURI(dataUrl,name);
    meta.appendChild(span); meta.appendChild(btn); card.appendChild(im); card.appendChild(meta); els.thumbs.appendChild(card);
    const s1=document.createElement('img'); s1.src=dataUrl; s1.alt=name; s1.style.display='block'; els.seamRow.appendChild(s1);
    const s2=document.createElement('img'); s2.src=dataUrl; s2.alt=name; s2.style.display='block'; els.lbRow.appendChild(s2);
  }
  els.outputCard.style.display='block'; els.dlAllBtn.disabled=false;
};

function downloadURI(uri, filename){ const a=document.createElement('a'); a.href=uri; a.download=filename; document.body.appendChild(a); a.click(); a.remove(); }
els.dlAllBtn.onclick = async ()=>{
  if(!outputs.length) return;
  const zip = new JSZip(); const folder = zip.folder('slices');
  await Promise.all(outputs.map(async o=>{ const res=await fetch(o.url); const blob=await res.blob(); folder.file(o.name, blob); }));
  const blob=await zip.generateAsync({type:'blob'}); const url=URL.createObjectURL(blob); downloadURI(url,'panorama_slices_3x4_seamsafe.zip'); URL.revokeObjectURL(url);
};
els.zipBtn.onclick=()=>els.dlAllBtn.onclick();

function openModal(src){ $('modalImg').src=src; $('modal').classList.add('open'); $('modal').setAttribute('aria-hidden','false'); }
function closeModal(){ $('modal').classList.remove('open'); $('modal').setAttribute('aria-hidden','true'); $('modalImg').removeAttribute('src'); }
$('modalClose').onclick=closeModal; $('modal').onclick=(e)=>{ if(e.target===$('modal')) closeModal(); };

function openSeam(){ $('lb').classList.add('open'); $('lb').setAttribute('aria-hidden','false'); updateLbZoom(); }
function closeSeam(){ $('lb').classList.remove('open'); $('lb').setAttribute('aria-hidden','true'); }
function updateLbZoom(){ const z=(parseInt($('lbZoom').value||'60'))/100; $('lbCanvas').style.transform=`scale(${z})`; }
$('seamOpen').onclick=openSeam; $('lbClose').onclick=closeSeam; $('lbZoom').oninput=updateLbZoom;

$('seamBorders').onchange=()=>{ const on=$('seamBorders').checked;
  $('seamRow').querySelectorAll('img').forEach(im=>im.style.outline=on?'1px solid magenta':'none');
  $('lbRow').querySelectorAll('img').forEach(im=>im.style.outline=on?'1px solid magenta':'none');
};

$('newBtn').onclick=resetAll;
</script>
</body>
</html>